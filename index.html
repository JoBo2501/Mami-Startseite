<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mutters Messageboard</title>
  <script src="https://unpkg.com/ical.js@1.4.0/build/ical.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; background: #f8f9fa; color: #333; text-align: center; margin: 0; }
    h1 { background: #fff475; font-size: 2rem; padding: 1rem; border-radius: 1rem; display: inline-block; margin: 2rem auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .section { margin: 2rem 0; }
    .section-title { font-weight: bold; font-size: 1.2rem; text-transform: uppercase; margin-bottom: 1rem; position: relative; display: inline-flex; align-items: center; }
    .weather, .termin-eintrag, .message {
      background: white; border-radius: 8px; padding: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); max-width: 600px; margin: 0 auto; text-align: left;
    }
    .message { background: #dcf8c6; border-left: 5px solid #444; position: relative; }
    .message-timestamp { font-size: 0.8rem; color: #666; text-align: right; margin-top: 0.5rem; }
    .message-alert::before {
      content: ""; position: absolute; left: -1.5rem; top: 1.2rem; width: 10px; height: 10px; background: red;
      border-radius: 50%; box-shadow: 0 0 8px red; animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0px red; }
      50% { box-shadow: 0 0 12px red; }
      100% { box-shadow: 0 0 0px red; }
    }
    .termin-eintrag { border-left: 5px solid #cc0000; margin-top: 1rem; }
    .reminder-list { list-style: none; padding: 0; max-width: 500px; margin: 0 auto; text-align: left; }
    .reminder-list li { margin-bottom: 0.5rem; }
    .message-with-avatar {
      display: flex;
      margin-bottom: 1rem;
      align-items: flex-start;
      width: 100%;
      max-width: 600px; /* Maximale Breite begrenzen */
      margin-left: auto;
      margin-right: auto;
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      margin-right: 10px;
      flex-shrink: 0;
      border: 1px solid #ddd;
      background-color: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .message-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .message-content {
      flex-grow: 1;
    }

    .message-sender {
      font-size: 0.8rem;
      font-weight: bold;
      margin-bottom: 2px;
      color: #555;
    }

    .message {
      background: #dcf8c6; 
      border-left: 5px solid #444; 
      position: relative;
      padding: 1rem;
      margin-top: 0;
      border-radius: 8px;
      font-size: 1.1rem; /* Größere Schrift */
      line-height: 1.4; /* Verbesserter Zeilenabstand */
    }

    .message a {
      color: #0066cc; /* Link-Farbe */
      text-decoration: underline;
      word-break: break-word; /* Lange URLs umbrechen */
    }

    .message-timestamp {
      font-size: 0.8rem;
      color: #666;
      text-align: right;
      margin-top: 0.5rem;
    }

    /* Stellen Sie sicher, dass der Avatar immer bei der Nachricht bleibt */
    @media (orientation: landscape) {
      .message-with-avatar {
        margin-left: auto;
        margin-right: auto;
        width: 100%;
        max-width: 600px;
      }
    }

    /* Blinkenden Punkt entfernen */
    .message-alert::before {
      display: none;
    }
    
    .digital-board {
      font-family: 'Courier New', monospace;
      background-color: #222;
      color: #f8b700;
      text-shadow: 0 0 5px #f8b700, 0 0 10px #f8b700;
      border: 8px solid #8b5a2b;
      border-radius: 8px;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.8), 0 5px 15px rgba(0,0,0,0.5);
      padding: 20px 15px;
      text-align: center;
      letter-spacing: 2px;
      margin: 20px auto;
      max-width: 600px;
      position: relative;
      background-image: linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px);
      background-size: 5px 5px;
    }

    .digital-board::before {
      content: "MESSAGE BOARD";
      position: absolute;
      top: 5px;
      left: 10px;
      font-size: 12px;
      opacity: 0.7;
    }

    .digital-board::after {
      content: "DIGITAL";
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 12px;
      opacity: 0.7;
    }

    .digital-board h1 {
      font-size: 2rem;
      font-weight: bold;
      background: none;
      border-radius: 0;
      margin: 5px 0;
      padding: 10px;
      box-shadow: none;
      text-transform: uppercase;
      display: inline-block;
      transform: scale(1, 1.2);
    }
    
    #led-title {
      color: #f8b700;
      text-shadow: 0 0 5px #f8b700, 0 0 10px #f8b700;
      font-size: 2rem;
      font-weight: bold;
      margin: 5px 0;
      padding: 10px;
      text-transform: uppercase;
      font-family: 'Courier New', monospace;
      letter-spacing: 4px;
    }

    /* Live-Indikator für neue Nachrichten */
    .new-indicator {
      display: inline-flex;
      align-items: center;
      margin-left: 10px;
      font-size: 0.85rem;
      color: #ff3b30;
      font-weight: bold;
    }

    .pulse-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #ff3b30;
      margin-right: 6px;
      animation: pulse 1.5s infinite;
    }

    /* Flip-Clock Styling */
    .flip-clock-container {
      display: flex;
      justify-content: center;
      margin: 1rem auto;
      perspective: 400px;
      max-width: 340px;
    }

    .flip-clock {
      background: #333;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      display: flex;
      padding: 10px 15px;
    }

    .flip-unit-container {
      display: flex;
      position: relative;
    }

    .digit-container {
      position: relative;
      width: 40px;
      height: 60px;
      perspective: 200px;
      margin: 0 2px;
    }

    .digit-top, .digit-bottom {
      position: absolute;
      width: 100%;
      height: 50%;
      overflow: hidden;
      background: #222;
      color: #fff;
      text-align: center;
      font-family: 'Digital-7', 'Courier New', monospace;
      font-size: 50px;
      line-height: 0;
      padding-top: 3px;
    }

    .digit-top {
      top: 0;
      border-radius: 3px 3px 0 0;
      border-bottom: 1px solid #333;
      transform-origin: bottom;
    }

    .digit-top span {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      line-height: 60px;
    }

    .digit-bottom {
      bottom: 0;
      border-radius: 0 0 3px 3px;
      line-height: 0;
    }

    .digit-bottom span {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      line-height: 60px;
    }

    .flip .digit-top {
      animation: flip-top 0.5s ease-in;
    }

    .flip .digit-bottom {
      animation: flip-bottom 0.5s ease-out;
    }

    @keyframes flip-top {
      0% {
        transform: rotateX(0deg);
      }
      100% {
        transform: rotateX(-90deg);
      }
    }

    @keyframes flip-bottom {
      0% {
        transform: rotateX(90deg);
      }
      100% {
        transform: rotateX(0deg);
      }
    }

    .divider {
      font-family: 'Digital-7', 'Courier New', monospace;
      font-size: 40px;
      color: #fff;
      line-height: 60px;
      margin: 0 5px;
    }
  </style>
</head>
<body>
  <div class="digital-board">
    <h1 id="led-title">MUTTERS MESSAGEBOARD</h1>
  </div>
  <div id="date"></div>
  
  <div class="flip-clock-container">
    <div class="flip-clock">
      <div class="flip-unit-container" id="hours">
        <div class="digit-container">
          <div class="digit-top">
            <span>0</span>
          </div>
          <div class="digit-bottom">
            <span>0</span>
          </div>
        </div>
        <div class="digit-container">
          <div class="digit-top">
            <span>0</span>
          </div>
          <div class="digit-bottom">
            <span>0</span>
          </div>
        </div>
      </div>
      <div class="divider">:</div>
      <div class="flip-unit-container" id="minutes">
        <div class="digit-container">
          <div class="digit-top">
            <span>0</span>
          </div>
          <div class="digit-bottom">
            <span>0</span>
          </div>
        </div>
        <div class="digit-container">
          <div class="digit-top">
            <span>0</span>
          </div>
          <div class="digit-bottom">
            <span>0</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="section"><div class="section-title">Nachricht von uns</div><div id="note"></div></div>
  <div class="section"><div class="section-title">Bevorstehende Termine</div><div id="ical"></div></div>
  <div class="section"><div class="section-title">Erinnerungen für heute</div><ul class="reminder-list" id="reminders">Lade Erinnerungen...</ul></div>
  <div class="section"><div class="section-title">Wetter heute in Pullach</div><div class="weather" id="weather">Lade Wetterdaten...</div></div>
  <div class="section"><div class="section-title">Familienbilder</div>
    <iframe 
      src="https://cnjf29.smugmug.com/frame/slideshow?key=C9mL3c&speed=3&transition=fade&autoStart=1"
      width="100%" height="500"
      style="border:none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);"
      allowfullscreen loading="lazy">
    </iframe>
  </div>

  <script>
    // Zeitstempel der letzten bekannten Nachricht
    let lastKnownMessageTime = localStorage.getItem('lastKnownMessageTime') || 0;

    // Funktion zum Hinzufügen oder Entfernen des "Neu"-Indikators
    function updateNewIndicator(hasNew) {
      // Finde den Nachrichtentitel
      const messageTitles = document.querySelectorAll('.section-title');
      let messageTitle = null;
      
      // Suche nach dem "Nachricht von uns" Titel
      for (let i = 0; i < messageTitles.length; i++) {
        if (messageTitles[i].textContent.includes('Nachricht von uns')) {
          messageTitle = messageTitles[i];
          break;
        }
      }
      
      if (messageTitle) {
        // Entferne vorhandenen Indikator falls vorhanden
        const existingIndicator = messageTitle.querySelector('.new-indicator');
        if (existingIndicator) {
          existingIndicator.remove();
        }
        
        // Füge Indikator hinzu, wenn neue Nachrichten vorhanden sind
        if (hasNew) {
          const newIndicator = document.createElement('span');
          newIndicator.className = 'new-indicator';
          
          const pulseDot = document.createElement('span');
          pulseDot.className = 'pulse-dot';
          
          newIndicator.appendChild(pulseDot);
          newIndicator.appendChild(document.createTextNode('Neu'));
          
          messageTitle.appendChild(newIndicator);
        }
      }
    }

    // Funktion zum Erkennen und Umwandeln von URLs in Links
    function linkifyText(text) {
      // Regex für URL-Erkennung (http/https/www und gängige Domains)
      const urlRegex = /(https?:\/\/[^\s]+)|(www\.[^\s]+\.[^\s]{2,})/g;
      
      // Text mit Links ersetzen
      return text.replace(urlRegex, function(url) {
        // Stelle sicher, dass die URL mit http:// oder https:// beginnt
        let href = url;
        if (url.indexOf('http') !== 0) {
          href = 'https://' + url;
        }
        
        // Erstelle einen Link
        return '<a href="' + href + '" target="_blank" rel="noopener">' + url + '</a>';
      });
    }

    // Datum und Uhrzeit Anzeige
    const now = new Date();
    document.getElementById("date").innerText = now.toLocaleDateString('de-DE', {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });

    // Flip-Clock-Funktionen
    function updateFlipClock() {
      const now = new Date();
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      
      updateDigit('hours', 0, hours[0]);
      updateDigit('hours', 1, hours[1]);
      updateDigit('minutes', 0, minutes[0]);
      updateDigit('minutes', 1, minutes[1]);
    }

    function updateDigit(unit, position, newValue) {
      const containers = document.querySelectorAll(`#${unit} .digit-container`);
      if (!containers || containers.length <= position) return;
      
      const container = containers[position];
      const currentTop = container.querySelector('.digit-top span');
      const currentBottom = container.querySelector('.digit-bottom span');
      
      // Wenn sich der Wert nicht geändert hat, nichts tun
      if (currentTop.textContent === newValue) return;
      
      // Neues Element für den Flip-Effekt erstellen
      const flipTop = document.createElement('div');
      flipTop.className = 'digit-top flip';
      flipTop.innerHTML = `<span>${currentTop.textContent}</span>`;
      
      const flipBottom = document.createElement('div');
      flipBottom.className = 'digit-bottom flip';
      flipBottom.innerHTML = `<span>${newValue}</span>`;
      
      // Aktuelle Elemente aktualisieren
      currentTop.textContent = newValue;
      currentBottom.textContent = newValue;
      
      // Flip-Elemente einfügen
      container.appendChild(flipTop);
      container.appendChild(flipBottom);
      
      // Nach der Animation entfernen
      setTimeout(() => {
        container.removeChild(flipTop);
        container.removeChild(flipBottom);
      }, 500);
    }

    // Uhr initial setzen und dann alle Sekunde aktualisieren
    updateFlipClock();
    setInterval(updateFlipClock, 1000);

    // Wetter-Anzeige mit CORS-Proxy
    const weatherCodes = {
      0: "☀️ Klar", 1: "🌤️ Überwiegend klar", 2: "🌥️ Teilweise bewölkt",
      3: "☁️ Bedeckt", 45: "🌫️ Nebel", 48: "🌫️ Nebel",
      51: "🌦️ Leichter Nieselregen", 61: "🌧️ Regen", 80: "🌧️ Schauer", 95: "⛈️ Gewitter"
    };

    fetch('https://corsproxy.io/?https://api.open-meteo.com/v1/forecast?latitude=48.066&longitude=11.520&current_weather=true')
      .then(res => {
        if (!res.ok) {
          throw new Error('Netzwerkantwort war nicht ok: ' + res.status);
        }
        return res.json();
      })
      .then(data => {
        const w = data.current_weather;
        const emoji = weatherCodes[w.weathercode] || "🌡️";
        document.getElementById("weather").innerText = `${emoji} Temperatur: ${w.temperature}°C, Wind: ${w.windspeed} km/h`;
      })
      .catch(error => {
        console.error("Fehler beim Laden der Wetterdaten:", error);
        document.getElementById("weather").innerText = "Fehler beim Laden der Wetterdaten: " + error.message;
      });

    // Profilbilder der Söhne mit korrekten Pfaden und Fallback
    const senderImages = {
      'Daniel': './Daniel.jpg',    // Mit relativer Pfadangabe
      'Joachim': './Joachim.jpg'   // Mit relativer Pfadangabe
    };

    // Google Sheet Abruf mit CORS-Proxy und automatischer Aktualisierung
    function fetchSheetData() {
      // Timestamp für Cache-Busting hinzufügen
      const timestamp = new Date().getTime();
      const randomParam = Math.floor(Math.random() * 10000000);
      const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRB56yMX7C4q-o3tDU4dVZGxive_c-x84aii2HXnI1RULRdYKqloZ9JtKcFHe0TXsmPbJOEOqZDtZUb/pub?output=tsv';
      
      // Alternativer CORS-Proxy für mehr Zuverlässigkeit
      const corsProxy = 'https://api.allorigins.win/raw?url=';
      
      fetch(corsProxy + encodeURIComponent(url) + '&_=' + timestamp + '&r=' + randomParam)
        .then(res => {
          if (!res.ok) {
            throw new Error('Netzwerkantwort war nicht ok: ' + res.status);
          }
          return res.text();
        })
        .then(text => {
          if (!text || text.trim() === '') {
            throw new Error('Leere Antwort vom Server');
          }
          
          const rows = text.trim().split('\n').map(row => row.split('\t'));
          
          const reminders = document.getElementById("reminders");
          const note = document.getElementById("note");
          reminders.innerHTML = "";
          note.innerHTML = "";

          const today = new Date().toISOString().split("T")[0];
          
          let hasNewMessages = false;
          let newestMessageTime = lastKnownMessageTime;

          rows.forEach((row, index) => {
            // Sicherere Destrukturierung mit Prüfung
            if (!row || row.length < 2) {
              console.log('Ungültige Zeile übersprungen:', row);
              return;
            }
            
            // Erweiterte Struktur: Typ, Inhalt, Absender, Datum, Zeitstempel
            const type = row[0];
            const content = row[1];
            const sender = row[2] || ""; // Absender
            const rawDate = row[3] || row[2]; // Datum (jetzt in Spalte D oder C, falls kein Absender)
            const timestamp = row[4]; // Zeitstempel aus Google Sheets
            
            if (!type || !content) return;

            // Sicherere Datumskonvertierung
            let isToday = false;
            try {
              isToday = !rawDate || new Date(rawDate).toISOString().split("T")[0] === today;
            } catch (e) {
              console.error('Fehler beim Parsen des Datums:', rawDate, e);
              isToday = !rawDate; // Fallback: ohne Datum ist es für "heute"
            }

            if (type === "Erinnerung" && isToday) {
              const li = document.createElement("li");
              li.textContent = "🔔 " + content;
              li.style.paddingLeft = "0.5rem";
              reminders.appendChild(li);
            }

            if (type === "Nachricht") {
              // Prüfe, ob es eine neue Nachricht ist
              if (timestamp && timestamp.trim()) {
                try {
                  const msgTime = new Date(timestamp.trim()).getTime();
                  if (msgTime > lastKnownMessageTime) {
                    hasNewMessages = true;
                    if (msgTime > newestMessageTime) {
                      newestMessageTime = msgTime;
                    }
                  }
                } catch (e) {
                  console.error("Fehler beim Vergleichen des Zeitstempels:", e);
                }
              }
              
              // Neues HTML-Structure für Nachrichten mit Absender
              const messageWrapper = document.createElement("div");
              messageWrapper.className = "message-with-avatar";
              
              // Profilbild für den Absender
              if (sender) {
                const avatarDiv = document.createElement("div");
                avatarDiv.className = "message-avatar";
                
                const avatarImg = document.createElement("img");
                avatarImg.src = senderImages[sender] || `https://ui-avatars.com/api/?name=${sender.charAt(0)}&background=777&color=fff`;
                avatarImg.alt = sender;
                
                // Fehlerbehandlung für Bilder
                avatarImg.onerror = function() {
                  console.log(`Bild konnte nicht geladen werden: ${this.src}`);
                  this.src = `https://ui-avatars.com/api/?name=${sender.charAt(0)}&background=777&color=fff&size=100`;
                };
                
                avatarDiv.appendChild(avatarImg);
                messageWrapper.appendChild(avatarDiv);
                
                // Absendername und Nachrichteninhalt
                const contentDiv = document.createElement("div");
                contentDiv.className = "message-content";
                
                const senderDiv = document.createElement("div");
                senderDiv.className = "message-sender";
                senderDiv.textContent = sender;
                contentDiv.appendChild(senderDiv);
                
                const p = document.createElement("p");
                p.className = "message";
                p.innerHTML = linkifyText(content);
                
                const ts = document.createElement("div");
                ts.className = "message-timestamp";

                // Versuche zuerst den Zeitstempel zu verwenden, dann das Datum, dann aktuelles Datum
                let messageDate;
                if (timestamp && timestamp.trim()) {
                  try {
                    messageDate = new Date(timestamp.trim());
                    if (isNaN(messageDate.getTime())) { // Ungültiges Zeitstempel-Format
                      // Fallback zum regulären Datum
                      if (rawDate && rawDate.trim()) {
                        messageDate = new Date(rawDate.trim());
                        if (isNaN(messageDate.getTime())) { // Auch ungültiges Datum
                          messageDate = new Date(); // Aktuelles Datum als letzter Fallback
                        }
                      } else {
                        messageDate = new Date();
                      }
                    }
                  } catch (e) {
                    console.error("Fehler beim Parsen des Zeitstempels:", timestamp, e);
                    // Versuche es mit dem regulären Datum
                    if (rawDate && rawDate.trim()) {
                      try {
                        messageDate = new Date(rawDate.trim());
                      } catch {
                        messageDate = new Date();
                      }
                    } else {
                      messageDate = new Date();
                    }
                  }
                } else if (rawDate && rawDate.trim()) {
                  // Kein Zeitstempel, versuche es mit dem regulären Datum
                  try {
                    messageDate = new Date(rawDate.trim());
                    if (isNaN(messageDate.getTime())) {
                      messageDate = new Date();
                    }
                  } catch (e) {
                    messageDate = new Date();
                  }
                } else {
                  messageDate = new Date();
                }

                // Formatiertes Datum und Uhrzeit anzeigen
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);

                let datePrefix = "";
                if (messageDate.toDateString() === today.toDateString()) {
                  datePrefix = "Heute";
                } else if (messageDate.toDateString() === yesterday.toDateString()) {
                  datePrefix = "Gestern";
                } else {
                  datePrefix = messageDate.toLocaleDateString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit'
                  });
                }

                // Zeitstempel setzen
                ts.textContent = `${datePrefix}, ${messageDate.toLocaleTimeString('de-DE', {
                  hour: '2-digit', 
                  minute: '2-digit',
                  hour12: false // Diese Option erzwingt das 24-Stunden-Format
                })}`;
                
                p.appendChild(ts);
                contentDiv.appendChild(p);
                messageWrapper.appendChild(contentDiv);
              } else {
                // Alte Struktur für Nachrichten ohne Absender (Abwärtskompatibilität)
                const p = document.createElement("p");
                p.className = "message";
                p.innerHTML = linkifyText(content);
                
                const ts = document.createElement("div");
                ts.className = "message-timestamp";
                ts.textContent = new Date().toLocaleTimeString('de-DE', {
                  hour: '2-digit', 
                  minute: '2-digit',
                  hour12: false
                });
                
                p.appendChild(ts);
                messageWrapper.appendChild(p);
              }
              
              note.appendChild(messageWrapper);
            }
          });
          
          // Aktualisiere den "Neu"-Indikator
          updateNewIndicator(hasNewMessages);
          
          // Aktualisiere den gespeicherten Zeitstempel für den nächsten Vergleich
          if (newestMessageTime > lastKnownMessageTime) {
            lastKnownMessageTime = newestMessageTime;
            localStorage.setItem('lastKnownMessageTime', newestMessageTime);
          }
          
          // Nachricht anzeigen, wenn keine Erinnerungen gefunden wurden
          if (reminders.children.length === 0) {
            reminders.innerHTML = "<em>Keine Erinnerungen für heute.</em>";
          }
        })
        .catch(err => {
          console.error("Detaillierter Fehler beim Laden der Erinnerungen:", err);
          document.getElementById("reminders").innerHTML = "<em>Fehler beim Laden der Erinnerungen: " + err.message + "</em>";
        });
    }

    // Initial ausführen
    fetchSheetData();

    // Alle 30 Sekunden nach Updates suchen
    setInterval(fetchSheetData, 30000); // 30000 ms = 30 Sekunden

    // Google Kalender Abruf mit dem ursprünglichen CORS-Proxy
    fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(
      'https://calendar.google.com/calendar
