<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mutters Messageboard</title>
  <!-- ICAL.js mit Fallback -->
  <script>
    // Versuche ICAL.js zu laden, aber breche nicht ab wenn es fehlschlägt
    const icalScript = document.createElement('script');
    icalScript.src = 'https://unpkg.com/ical.js@1.4.0/build/ical.min.js';
    icalScript.onerror = function() {
      console.log('⚠️ ICAL.js konnte nicht geladen werden - Kalender-Funktion wird deaktiviert');
      window.ICAL_AVAILABLE = false;
    };
    icalScript.onload = function() {
      console.log('✅ ICAL.js erfolgreich geladen');
      window.ICAL_AVAILABLE = true;
    };
    document.head.appendChild(icalScript);
  </script>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; 
      padding: 2rem; 
      background: #f8fafc;
      color: #333; 
      text-align: center; 
      margin: 0; 
      min-height: 100vh;
    }
    h1 { 
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fed7aa 100%);
      font-size: 2rem; 
      padding: 1.5rem 2rem; 
      border-radius: 25px; 
      display: inline-block; 
      margin: 2rem auto; 
      box-shadow: 
        0 20px 40px rgba(0,0,0,0.08),
        0 10px 20px rgba(0,0,0,0.04),
        inset 0 1px 0 rgba(255,255,255,0.5);
      border: 1px solid rgba(251, 191, 36, 0.3);
      backdrop-filter: blur(10px);
      color: #92400e;
    }
    .section { 
      margin: 3rem 0; 
      animation: fadeInUp 0.6s ease-out;
    }
    .section-title { 
      font-weight: 600; 
      font-size: 1.3rem; 
      text-transform: none;
      margin-bottom: 1.5rem; 
      color: #1e293b;
      text-shadow: none;
      letter-spacing: 0.5px;
    }
    .weather, .termin-eintrag, .message {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border-radius: 20px; 
      padding: 1.5rem; 
      box-shadow: 
        0 20px 40px rgba(0,0,0,0.1),
        0 10px 20px rgba(0,0,0,0.05),
        inset 0 1px 0 rgba(255,255,255,0.2);
      max-width: 600px; 
      margin: 0 auto 1.5rem auto; 
      text-align: left;
      border: 1px solid rgba(255,255,255,0.15);
      transition: all 0.3s ease;
    }
    .weather:hover, .termin-eintrag:hover, .message:hover {
      transform: translateY(-5px);
      box-shadow: 
        0 30px 60px rgba(0,0,0,0.15),
        0 15px 30px rgba(0,0,0,0.1),
        inset 0 1px 0 rgba(255,255,255,0.3);
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .message { 
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.25) 0%, 
        rgba(255, 255, 255, 0.1) 100%);
      border-left: 4px solid #4facfe;
      position: relative; 
      font-size: 1.1rem;
      line-height: 1.6;
      margin-top: 2px;
      backdrop-filter: blur(25px);
      border-radius: 18px;
      color: #2c3e50;
      font-weight: 500;
    }
    .message a {
      color: #3498db;
      text-decoration: none;
      word-break: break-word;
      border-bottom: 1px solid rgba(52, 152, 219, 0.3);
      transition: all 0.3s ease;
    }
    .message a:hover {
      border-bottom: 1px solid #3498db;
      color: #2980b9;
    }
    .message-timestamp { 
      font-size: 0.85rem; 
      color: rgba(0,0,0,0.6); 
      text-align: right; 
      margin-top: 0.8rem;
      font-weight: 500;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
    }
    .termin-eintrag { 
      border-left: 4px solid #e74c3c; 
      margin-top: 1rem; 
      background: linear-gradient(135deg, 
        rgba(231, 76, 60, 0.1) 0%, 
        rgba(255, 255, 255, 0.15) 100%);
      color: #2c3e50;
      font-weight: 500;
    }
    .reminder-list { 
      list-style: none; 
      padding: 0; 
      max-width: 500px; 
      margin: 0 auto; 
      text-align: left; 
    }
    .reminder-list li { 
      margin-bottom: 0.8rem;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(15px);
      padding: 1rem 1.5rem;
      border-radius: 15px;
      border: 1px solid rgba(255,255,255,0.1);
      color: #2c3e50;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    .reminder-list li:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateX(10px);
    }
    .message-with-avatar {
      display: flex;
      margin-bottom: 1.5rem;
      align-items: flex-start;
    }
    .message-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      overflow: hidden;
      margin-right: 15px;
      flex-shrink: 0;
      border: 3px solid rgba(255,255,255,0.3);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .message-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .message-content {
      flex-grow: 1;
      position: relative;
    }
    .message-sender {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: #34495e;
      letter-spacing: 0.3px;
    }
    
    .new-indicator {
      font-size: 0.95rem;
      font-weight: 600;
      color: #e74c3c;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      letter-spacing: 0.3px;
    }
    
    .new-indicator::before {
      content: "";
      display: inline-block;
      width: 10px;
      height: 10px;
      background: linear-gradient(45deg, #ff6b6b, #ee5a24);
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse-modern 2s infinite;
      box-shadow: 0 0 10px rgba(238, 90, 36, 0.5);
    }
    
    @keyframes pulse-modern {
      0% { 
        transform: scale(1);
        box-shadow: 0 0 10px rgba(238, 90, 36, 0.5);
      }
      50% { 
        transform: scale(1.2);
        box-shadow: 0 0 20px rgba(238, 90, 36, 0.8);
      }
      100% { 
        transform: scale(1);
        box-shadow: 0 0 10px rgba(238, 90, 36, 0.5);
      }
    }
    
    .message {
      margin-top: 2px;
    }
    .message-with-avatar {
      display: flex;
      margin-bottom: 1rem;
      align-items: flex-start;
      width: 100%;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      position: relative;
    }
    @media (orientation: landscape) {
      .message-with-avatar {
        margin-left: auto;
        margin-right: auto;
        width: 100%;
        max-width: 600px;
      }
    }

    /* Modernisierte Apple Watch-Style Uhr mit Alpenpanorama */
    .digital-board {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: 
        /* Morgenhimmel-Gradient */
        linear-gradient(to bottom, 
          rgba(255, 183, 77, 0.9) 0%,     /* Warmes Morgengold oben */
          rgba(255, 150, 90, 0.85) 15%,   /* Orange-Rosa */
          rgba(255, 180, 120, 0.8) 30%,   /* Sanftes Orange */
          rgba(135, 180, 220, 0.7) 70%,   /* Himmelblau */
          rgba(100, 150, 200, 0.75) 100%  /* Tieferes Blau unten */
        ),
        /* Alpenkette Silhouette */
        radial-gradient(ellipse 200px 80px at 15% 100%, rgba(60, 80, 120, 0.9) 0%, transparent 70%),
        radial-gradient(ellipse 150px 100px at 35% 100%, rgba(70, 90, 130, 0.85) 0%, transparent 70%),
        radial-gradient(ellipse 180px 120px at 55% 100%, rgba(80, 100, 140, 0.8) 0%, transparent 70%),
        radial-gradient(ellipse 160px 90px at 75% 100%, rgba(65, 85, 125, 0.85) 0%, transparent 70%),
        radial-gradient(ellipse 140px 70px at 90% 100%, rgba(75, 95, 135, 0.9) 0%, transparent 70%);
      color: #ffffff;
      text-shadow: 0 2px 8px rgba(0,0,0,0.7), 0 1px 3px rgba(0,0,0,0.9);
      border-radius: 25px;
      box-shadow: 
        inset 0 2px 15px rgba(255,255,255,0.2),
        inset 0 -2px 10px rgba(0,0,0,0.2),
        0 8px 32px rgba(0,0,0,0.3),
        0 2px 8px rgba(0,0,0,0.2);
      padding: 30px 25px;
      text-align: center;
      margin: 20px auto;
      max-width: 600px;
      position: relative;
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(5px);
      overflow: hidden;
    }

    /* Subtiler Glanz-Effekt */
    .digital-board::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 50%;
      background: linear-gradient(to bottom, 
        rgba(255,255,255,0.08) 0%, 
        rgba(255,255,255,0.02) 50%, 
        transparent 100%);
      border-radius: 25px 25px 0 0;
      pointer-events: none;
    }

    .date-display {
      color: #e8e8e8;
      font-size: 1.4rem;
      font-weight: 600;
      margin: 0 0 8px 0;
      padding: 5px 10px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.6);
    }
    
    .time-display {
      color: #ffffff;
      font-size: 3.2rem;
      font-weight: 300;
      margin: 0;
      padding: 5px 10px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      letter-spacing: 1px;
      text-shadow: 0 2px 6px rgba(0,0,0,0.8);
      font-variant-numeric: tabular-nums;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .digital-board {
        padding: 20px 15px;
        margin: 15px auto;
      }
      
      .date-display {
        font-size: 1.1rem;
      }
      
      .time-display {
        font-size: 2.5rem;
      }
    }
    
    .post-it-sticker {
      position: fixed;
      top: 20%;
      left: -25px;
      width: 220px;
      height: auto;
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
      border-radius: 12px;
      box-shadow: 
        0 15px 30px rgba(0,0,0,0.2),
        inset 0 1px 0 rgba(255,255,255,0.6),
        inset 0 -1px 0 rgba(0,0,0,0.1);
      transform: rotate(-4deg);
      z-index: 1000;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      border: 1px solid rgba(255,215,0,0.3);
      animation: gentle-sway-modern 8s ease-in-out infinite;
      backdrop-filter: blur(5px);
    }

    @keyframes gentle-sway-modern {
      0%, 100% { transform: rotate(-4deg) translateY(0px); }
      25% { transform: rotate(-2deg) translateY(-3px); }
      50% { transform: rotate(-5deg) translateY(2px); }
      75% { transform: rotate(-1deg) translateY(-1px); }
    }

    .post-it-content {
      padding: 1.5rem;
      text-align: center;
    }

    .post-it-title {
      font-size: 1rem;
      font-weight: 700;
      color: #d63031;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .post-it-text {
      font-size: 0.9rem;
      color: #2d3436;
      line-height: 1.4;
      font-weight: 600;
    }

    .post-it-sticker::before {
      content: "";
      position: absolute;
      top: -8px;
      left: 25px;
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border-radius: 50%;
      box-shadow: 
        0 4px 8px rgba(0,0,0,0.15),
        inset 0 1px 0 rgba(255,255,255,0.8);
      border: 2px solid rgba(255,193,7,0.6);
    }

    @media (max-width: 768px) {
      .post-it-sticker {
        left: -15px;
        width: 200px;
        top: 25%;
      }
      
      .post-it-title {
        font-size: 0.9rem;
      }
      
      .post-it-text {
        font-size: 0.8rem;
      }
    }

    .post-it-sticker:hover {
      transform: rotate(0deg) scale(1.05) translateY(-5px);
      box-shadow: 
        0 25px 50px rgba(0,0,0,0.25),
        inset 0 1px 0 rgba(255,255,255,0.6),
        inset 0 -1px 0 rgba(0,0,0,0.1);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .battery-warning {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      color: white;
      padding: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: pulse-warning-modern 2s infinite;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
    }

    @keyframes pulse-warning-modern {
      0% { 
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      }
      50% { 
        background: linear-gradient(135deg, #ff5252 0%, #f44336 100%);
        box-shadow: 0 15px 40px rgba(255,107,107,0.5);
      }
      100% { 
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      }
    }

    .battery-icon {
      font-size: 3rem;
      margin-right: 20px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }

    .battery-message {
      font-size: 1.3rem;
    }

    .battery-title {
      font-weight: 700;
      font-size: 1.6rem;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      letter-spacing: 0.5px;
    }

    .hidden {
      display: none;
    }

    /* VERBESSERTE PRESSESCHAU STYLES */
    .presseschau-section {
      max-width: 900px;
      margin: 0 auto;
    }

    .presseschau-section .section-title {
      font-size: 1.8rem;
      color: #1a202c;
      margin-bottom: 2.5rem;
      padding: 1.5rem 2.5rem;
      background: linear-gradient(135deg, 
        rgba(52, 152, 219, 0.25) 0%, 
        rgba(41, 128, 185, 0.18) 100%);
      backdrop-filter: blur(15px);
      border-radius: 25px;
      display: inline-block;
      position: relative;
      border: 1px solid rgba(255,255,255,0.25);
      text-shadow: 0 2px 6px rgba(0,0,0,0.15);
      font-weight: 800;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      box-shadow: 
        0 15px 35px rgba(0,0,0,0.1),
        inset 0 1px 0 rgba(255,255,255,0.3);
    }

    .presseschau-section .section-title::before {
      content: "📰";
      margin-right: 15px;
      font-size: 1.4em;
    }

    .news-container {
      display: flex;
      flex-direction: column;
      gap: 3rem;
    }

    .no-articles-message {
      text-align: center;
      padding: 4rem 2rem;
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.15) 0%, 
        rgba(255, 255, 255, 0.08) 100%);
      backdrop-filter: blur(20px);
      border-radius: 25px;
      border: 1px solid rgba(255,255,255,0.2);
      color: #64748b;
      font-size: 1.2rem;
      font-style: italic;
    }

    .news-article {
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.25) 0%, 
        rgba(255, 255, 255, 0.12) 100%);
      backdrop-filter: blur(25px);
      border-radius: 25px;
      padding: 2.5rem;
      box-shadow: 
        0 25px 50px rgba(0,0,0,0.12),
        0 12px 25px rgba(0,0,0,0.08),
        inset 0 1px 0 rgba(255,255,255,0.3);
      border: 1px solid rgba(255,255,255,0.2);
      transition: all 0.3s ease;
      text-align: left;
      position: relative;
    }

    .news-article:hover {
      transform: translateY(-8px);
      box-shadow: 
        0 35px 70px rgba(0,0,0,0.18),
        0 20px 40px rgba(0,0,0,0.12),
        inset 0 1px 0 rgba(255,255,255,0.4);
    }

    .news-article.featured {
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.3) 0%, 
        rgba(255, 255, 255, 0.15) 100%);
      padding: 3rem;
    }

    .news-article.featured::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
      border-radius: 25px 25px 0 0;
    }

    .news-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1.5rem;
    }

    .news-source {
      font-size: 0.95rem;
      font-weight: 800;
      color: #28a745;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      padding: 0.6rem 1.4rem;
      background: linear-gradient(135deg, 
        rgba(40, 167, 69, 0.15) 0%, 
        rgba(32, 201, 151, 0.1) 100%);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      border: 1px solid rgba(40, 167, 69, 0.25);
      display: inline-block;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.15);
    }

    .news-meta {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .news-date {
      font-size: 0.9rem;
      color: rgba(0,0,0,0.65);
      font-weight: 600;
      padding: 0.6rem 1.4rem;
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.3);
    }

    .news-reading-time {
      font-size: 0.85rem;
      color: rgba(0,0,0,0.5);
      font-weight: 500;
      padding: 0.5rem 1rem;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      border: 1px solid rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .news-reading-time::before {
      content: "⏱️";
      font-size: 0.9em;
    }

    .news-title {
      font-size: 2rem;
      font-weight: 900;
      color: #1a202c;
      line-height: 1.2;
      margin-bottom: 1.5rem;
      font-family: Georgia, 'Times New Roman', serif;
      text-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }

    .news-article.featured .news-title {
      font-size: 2.6rem;
      margin-bottom: 2rem;
    }

    .news-subtitle {
      font-size: 1.3rem;
      font-weight: 600;
      color: #4a5568;
      line-height: 1.5;
      margin-bottom: 2rem;
      font-style: italic;
      border-left: 4px solid #28a745;
      padding-left: 1.5rem;
      background: rgba(40, 167, 69, 0.05);
      padding-top: 1rem;
      padding-bottom: 1rem;
      border-radius: 0 15px 15px 0;
    }

    .news-content {
      font-size: 1.15rem;
      line-height: 1.9;
      color: #2d3748;
      font-weight: 400;
      text-align: justify;
      hyphens: auto;
    }

    .news-content p {
      margin-bottom: 1.5rem;
    }

    .news-content p:first-of-type:first-letter {
      font-size: 3.5rem;
      font-weight: 900;
      color: #28a745;
      float: left;
      line-height: 0.8;
      padding-right: 8px;
      margin-top: 8px;
      margin-right: 2px;
      font-family: Georgia, serif;
    }

    .news-byline {
      font-size: 1rem;
      color: #718096;
      font-weight: 600;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 2px solid rgba(255,255,255,0.4);
      text-align: right;
      font-style: italic;
    }

    .news-byline::before {
      content: "✍️ ";
      margin-right: 5px;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
<!-- Batteriestand-Warnung -->
<div id="battery-warning" class="battery-warning hidden">
  <div class="battery-icon">🔋</div>
  <div class="battery-message">
    <div class="battery-title">LIEBE MAMI, KANNST DU MICH JETZT BITTE IN DIE LADESTATION BRINGEN?</div>
    <div class="battery-level">Batteriestand: <span id="battery-percentage">--</span>%</div>
  </div>
</div>

<!-- Permanenter Post-it Sticker -->
<div class="post-it-sticker">
  <div class="post-it-content">
    <div class="post-it-title">WICHTIGER HINWEIS</div>
    <div class="post-it-text">
      Sanja bitte bis auf weiteres nicht mehr bar bezahlen, das erfolgt jetzt online!
    </div>
  </div>
</div>

  <div class="digital-board">
    <div id="date" class="date-display">Lädt...</div>
    <div id="time" class="time-display">--:--</div>
  </div>
  <div class="section"><div class="section-title">Nachrichten von den Söhnen</div><div id="note">Lade Nachrichten...</div></div>
  <div class="section"><div class="section-title">Bevorstehende Termine</div><div id="ical">Lade Termine...</div></div>
  <div class="section"><div class="section-title">Wetter heute in Pullach</div><div class="weather" id="weather">Lade Wetterdaten...</div></div>
  
  <!-- DYNAMISCHE PRESSESCHAU SECTION MIT GOOD NEWS FILTER -->
  <div class="section presseschau-section">
    <div class="section-title">Presseschau</div>
    <div class="news-container" id="news-container">
      <div class="no-articles-message">
        <p>📰 Lade positive Nachrichten...</p>
        <p>Manuelle und automatische Artikel werden geladen!</p>
      </div>
    </div>
  </div>
  
  <div class="section"><div class="section-title">Erinnerungen für heute</div><ul class="reminder-list" id="reminders">Lade Erinnerungen...</ul></div>
  <div class="section"><div class="section-title">Unsere Reise nach Avignon</div>
    <iframe 
  src="https://cnjf29.smugmug.com/frame/slideshow?key=k8fCVk&speed=3&transition=fade&autoStart=1&captions=0&navigation=0&playButton=0&randomize=0&transitionSpeed=2"
  width="100%" height="500"
  style="border:none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);"
  allowfullscreen loading="lazy">
</iframe>
  </div>

  <script>
    console.log('🚀 Mutters Messageboard startet...');

    // GOOD NEWS FILTER - Positive Keywords für eine 89-jährige Dame
    const positiveKeywords = [
      // Tiere 🐾
      'hund', 'hunde', 'katze', 'katzen', 'tier', 'tiere', 'zoo', 'tierpark', 'welpe', 'welpen', 
      'kätzchen', 'tierrettung', 'tierschutz', 'wildtier', 'vogel', 'vögel', 'pferd', 'pferde',
      'elefant', 'panda', 'delfin', 'therapietier', 'haustier', 'rettung', 'geboren', 'nachwuchs',
      
      // Religion & Spiritualität ⛪
      'papst', 'franziskus', 'kirche', 'kirchen', 'segen', 'segnung', 'pilger', 'pilgerreise',
      'weihnachten', 'ostern', 'pfingsten', 'erntedank', 'gottesdienst', 'gebet', 'frieden',
      'nächstenliebe', 'hoffnung', 'glaube', 'gemeinde', 'pfarrer', 'pastor', 'kloster',
      
      // Königshäuser & Adel 👑
      'könig', 'königin', 'prinz', 'prinzessin', 'kaiser', 'royal', 'majestät', 'hoheit',
      'schloss', 'palace', 'windsor', 'buckingham', 'neuschwanstein', 'bavaria', 'bayern',
      'hochzeit', 'krönung', 'jubiläum', 'thronfolge', 'adel', 'herzog', 'herzogin',
      
      // Positive Emotionen & Events ✨
      'freude', 'glück', 'erfolg', 'triumph', 'sieg', 'gewonnen', 'auszeichnung', 'ehrung',
      'geburtstag', 'anniversary', 'feier', 'fest', 'festival', 'konzert', 'musik',
      'hochzeit', 'verlobung', 'baby', 'geburt', 'enkel', 'großeltern', 'familie',
      
      // Hilfe & Soziales 💕
      'hilfe', 'helfen', 'unterstützung', 'spende', 'charity', 'ehrenamt', 'freiwillig',
      'nachbarschaftshilfe', 'zusammenhalt', 'gemeinschaft', 'solidarität', 'teilen',
      
      // Kultur & Kunst 🎨
      'museum', 'ausstellung', 'kunst', 'künstler', 'maler', 'skulptur', 'galerie',
      'theater', 'oper', 'klassik', 'symphonie', 'chor', 'orchester', 'dirigent',
      
      // Natur & Schönheit 🌸
      'garten', 'blume', 'blumen', 'rose', 'rosen', 'tulpe', 'frühling', 'sommer',
      'park', 'botanisch', 'natur', 'landschaft', 'berg', 'berge', 'see', 'wald',
      
      // Gesundheit & Fortschritt 🏥
      'heilung', 'geheilt', 'medizin', 'durchbruch', 'therapie', 'genesung', 'gesund',
      'forschung', 'entdeckung', 'erfindung', 'innovation', 'fortschritt',
      
      // Lokales & Traditionen 🏡
      'tradition', 'brauchtum', 'handwerk', 'heimat', 'dorf', 'gemeinde', 'regional',
      'oktoberfest', 'wiesn', 'tracht', 'dirndl', 'lederhose', 'alpen', 'bavaria'
    ];
    
    const negativeKeywords = [
      // Gewalt & Konflikte
      'krieg', 'tod', 'sterben', 'unfall', 'crash', 'kollision', 'explosion', 'brand',
      'gewalt', 'angriff', 'überfall', 'mord', 'terror', 'attentat', 'schießerei',
      'verletzt', 'verwundet', 'opfer', 'täter', 'verhaftet', 'gefängnis',
      
      // Krankheit & Leid
      'krebs', 'tumor', 'krankheit', 'pandemie', 'virus', 'covid', 'seuche',
      'depression', 'selbstmord', 'suizid', 'drogen', 'alkohol', 'sucht',
      
      // Wirtschaftliche Probleme
      'krise', 'inflation', 'teuer', 'pleite', 'konkurs', 'arbeitslos', 'armut',
      'schulden', 'betrug', 'skandal', 'korruption',
      
      // Katastrophen
      'katastrophe', 'unwetter', 'sturm', 'hochwasser', 'überschwemmung', 'erdbeben',
      'tsunami', 'dürre', 'waldbrand', 'evakuierung', 'notstand'
    ];

    // Funktion zur Überprüfung ob ein Artikel positiv ist
    function isPositiveArticle(title, content, subtitle) {
      const fullText = (title + ' ' + content + ' ' + (subtitle || '')).toLowerCase();
      
      // Zähle positive und negative Keywords
      let positiveScore = 0;
      let negativeScore = 0;
      
      positiveKeywords.forEach(keyword => {
        if (fullText.includes(keyword)) {
          positiveScore++;
        }
      });
      
      negativeKeywords.forEach(keyword => {
        if (fullText.includes(keyword)) {
          negativeScore += 2; // Negative Keywords bekommen mehr Gewicht
        }
      });
      
      // Artikel ist positiv wenn positive Score höher ist UND keine negativen Keywords
      return positiveScore > 0 && negativeScore === 0;
    }

    // Profilbilder der Söhne
    const senderImages = {
      'Daniel': './Daniel.jpg',
      'Joachim': './Joachim.jpg'
    };

    // URL-Links erkennen und verlinken
    function linkifyText(text) {
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, function(url) {
        return '<a href="' + url + '" target="_blank">' + url + '</a>';
      });
    }

    // Lesezeit schätzen
    function estimateReadingTime(text) {
      const wordsPerMinute = 200;
      const wordCount = text.trim().split(/\s+/).length;
      const minutes = Math.ceil(wordCount / wordsPerMinute);
      return minutes + (minutes === 1 ? ' Min.' : ' Min.');
    }

    // DATUM UND UHRZEIT - STABILE VERSION
    function initDateTime() {
      console.log("⏰ Initialisiere Datum und Uhrzeit...");
      
      try {
        const now = new Date();
        const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
        const months = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
        
        const weekday = weekdays[now.getDay()];
        const day = now.getDate();
        const month = months[now.getMonth()];
        const year = now.getFullYear();
        
        document.getElementById("date").innerHTML = `<strong>${weekday}, ${day}. ${month} ${year}</strong>`;
        console.log("✅ Datum gesetzt");
        
        updateClock();
      } catch (error) {
        console.error("❌ Fehler bei Datum/Uhrzeit:", error);
        document.getElementById("date").innerHTML = "Datum nicht verfügbar";
        document.getElementById("time").innerHTML = "Zeit nicht verfügbar";
      }
    }
    
    function updateClock() {
      try {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        document.getElementById("time").innerHTML = `${hours}:${minutes}`;
      } catch (error) {
        console.error("❌ Uhrzeitfehler:", error);
      }
    }

    // WETTER LADEN - ROBUSTE VERSION MIT MEHREREN FALLBACKS
    async function loadWeather() {
      console.log("🌤️ Lade Wetter...");
      
      const weatherElement = document.getElementById("weather");
      if (!weatherElement) return;
      
      const weatherCodes = {
        0: "☀️ Klar", 1: "🌤️ Überwiegend klar", 2: "🌥️ Teilweise bewölkt",
        3: "☁️ Bedeckt", 45: "🌫️ Nebel", 48: "🌫️ Nebel",
        51: "🌦️ Leichter Nieselregen", 61: "🌧️ Regen", 80: "🌧️ Schauer", 95: "⛈️ Gewitter"
      };

      const apis = [
        'https://api.open-meteo.com/v1/forecast?latitude=48.066&longitude=11.520&current_weather=true&timezone=Europe%2FBerlin',
        'https://corsproxy.io/?https://api.open-meteo.com/v1/forecast?latitude=48.066&longitude=11.520&current_weather=true&timezone=Europe%2FBerlin',
        'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://api.open-meteo.com/v1/forecast?latitude=48.066&longitude=11.520&current_weather=true&timezone=Europe%2FBerlin')
      ];

      for (const api of apis) {
        try {
          const response = await fetch(api);
          if (!response.ok) continue;
          
          const data = await response.json();
          const w = data.current_weather;
          const emoji = weatherCodes[w.weathercode] || "🌡️";
          
          let weatherComment = "";
          if (w.weathercode <= 2) {
            weatherComment = "– Heute wird ein sehr schöner Tag!";
          } else if (w.weathercode === 3) {
            weatherComment = "– Heute ist der Himmel bedeckt.";
          } else if (w.weathercode >= 51 && w.weathercode <= 67) {
            weatherComment = "– Heute musst Du für einen Spaziergang den Regenschirm mitnehmen.";
          } else if (w.weathercode >= 95) {
            weatherComment = "– Heute gibt es Gewitter, bitte bleib zu Hause!";
          }
          
          let temperatureComment = "";
          if (w.temperature < 5) {
            temperatureComment = "Es ist sehr kalt, bitte warm anziehen!";
          } else if (w.temperature < 12) {
            temperatureComment = "Es ist frisch, eine Jacke wäre gut.";
          } else if (w.temperature < 20) {
            temperatureComment = "Die Temperatur ist angenehm.";
          } else if (w.temperature < 26) {
            temperatureComment = "Es ist schön warm heute.";
          } else {
            temperatureComment = "Es ist sehr warm, denk an genug Wasser!";
          }
          
          weatherElement.innerHTML = `
            <div style="font-size: 1.1rem; margin-bottom: 10px">
              <strong>${emoji}</strong> ${weatherComment}
            </div>
            <div style="margin: 5px 0; font-size: 1.1rem">
              🌡️ <strong>${Math.round(w.temperature)}°C</strong> - ${temperatureComment}
            </div>
            <div style="margin: 5px 0; font-size: 1.1rem">
              💨 <strong>${Math.round(w.windspeed)} km/h</strong>
            </div>
          `;
          
          console.log("✅ Wetter geladen");
          return;
          
        } catch (error) {
          console.log(`⚠️ Wetter-API ${api} fehlgeschlagen:`, error.message);
        }
      }
      
      // Fallback wenn alle APIs fehlschlagen
      weatherElement.innerHTML = `
        <div style="font-size: 1.1rem; margin-bottom: 10px">
          <strong>🌡️</strong> Wetter-Service momentan nicht verfügbar
        </div>
        <div style="margin: 5px 0; font-size: 0.9rem; color: #666;">
          Bitte später erneut versuchen.
        </div>
      `;
      console.log("❌ Alle Wetter-APIs fehlgeschlagen");
    }

    // FALLBACK ARTIKEL - IMMER VERFÜGBAR
    function getFallbackArticles() {
      const today = new Date().toISOString().split('T')[0];
      
      return [
        {
          title: "Papst Franziskus segnet neue Friedensinitiative",
          content: "Papst Franziskus hat heute eine neue internationale Friedensinitiative gesegnet, die Religionsvertreter aus aller Welt zusammenbringt. Die Initiative „Brücken des Friedens" wurde im Vatikan vorgestellt und soll besonders in Konfliktregionen wirken. Bereits über 150 Organisationen aus 80 Ländern haben ihre Unterstützung zugesagt. Der Papst betonte die Wichtigkeit des Dialogs zwischen den Kulturen und Religionen für eine friedlichere Welt.",
          source: "Vatikan News",
          date: today,
          featured: true,
          isAutoGenerated: true
        },
        {
          title: "Tierpark München begrüßt Elefantenbaby",
          content: "Der Münchner Tierpark Hellabrunn freut sich über Nachwuchs bei den Asiatischen Elefanten. Das Elefantenbaby kam gesund zur Welt und entwickelt sich prächtig. Die Elefantenmutter kümmert sich liebevoll um ihren Nachwuchs, der bereits die ersten Gehversuche unternommen hat. Besucher können das kleine Elefantenkind bereits bewundern, wobei die Tierpfleger auf genügend Ruhe für Mutter und Kind achten.",
          source: "Tierpark Hellabrunn",
          date: today,
          featured: false,
          isAutoGenerated: true
        },
        {
          title: "Königin Camilla besucht Londoner Kunstzentrum",
          content: "Königin Camilla hat das neue British Centre for Contemporary Arts in London besucht und dabei besonders die Abteilung für Therapie durch Kunst gewürdigt. Das Zentrum bietet Menschen aller Altersgruppen die Möglichkeit, sich künstlerisch zu betätigen und dabei neue Freundschaften zu schließen. Die Königin zeigte sich begeistert von den vielfältigen Programmen und unterhielt sich ausführlich mit Teilnehmern und Künstlern.",
          source: "Royal Family News",
          date: today,
          featured: false,
          isAutoGenerated: true
        }
      ];
    }

    // GOOGLE SHEETS LADEN - VEREINFACHTE ROBUSTE VERSION
    async function fetchSheetData() {
      console.log("📊 Lade Google Sheets...");
      
      const timestamp = new Date().getTime();
      const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRB56yMX7C4q-o3tDU4dVZGxive_c-x84aii2HXnI1RULRdYKqloZ9JtKcFHe0TXsmPbJOEOqZDtZUb/pub?output=tsv';
      
      const reminders = document.getElementById("reminders");
      const note = document.getElementById("note");
      const newsContainer = document.getElementById("news-container");
      
      if (!reminders || !note || !newsContainer) {
        console.error("❌ DOM Elemente nicht gefunden");
        return;
      }
      
      // Reset
      reminders.innerHTML = "";
      note.innerHTML = "";
      
      const articles = [];
      const today = new Date().toISOString().split("T")[0];
      
      // Zuerst Fallback-Artikel laden
      const fallbackArticles = getFallbackArticles();
      articles.push(...fallbackArticles);
      console.log(`📰 ${fallbackArticles.length} Fallback-Artikel geladen`);
      
      const apis = [
        'https://api.allorigins.win/raw?url=' + encodeURIComponent(url) + '&timestamp=' + timestamp,
        'https://corsproxy.io/?' + encodeURIComponent(url) + '&t=' + timestamp,
        url + '?t=' + timestamp // Direkter Aufruf
      ];

      for (const api of apis) {
        try {
          console.log("📊 Versuche API:", api.substring(0, 50) + "...");
          
          const response = await fetch(api);
          if (!response.ok) continue;
          
          const text = await response.text();
          
          if (!text || text.trim() === '' || text.includes('<!DOCTYPE')) {
            continue;
          }
          
          const rows = text.trim().split('\n').map(row => row.split('\t'));
          console.log(`📋 ${rows.length} Zeilen gefunden`);

          let remindersFound = 0;
          let messagesFound = 0;
          let articlesFound = 0;

          rows.forEach((row) => {
            if (!row || row.length < 2) return;
            
            const type = row[0];
            const content = row[1];
            const sender = row[2] || "";
            const rawDate = row[3] || "";
            const timestamp = row[4] || "";
            const extra1 = row[5] || "";
            const extra2 = row[6] || "";
            const extra3 = row[7] || "";
            
            if (!type || !content) return;

            let isToday = false;
            try {
              isToday = !rawDate || new Date(rawDate).toISOString().split("T")[0] === today;
            } catch (e) {
              isToday = !rawDate;
            }

            // ERINNERUNGEN
            if (type === "Erinnerung" && isToday) {
              const li = document.createElement("li");
              li.textContent = "🔔 " + content;
              reminders.appendChild(li);
              remindersFound++;
            }

            // NACHRICHTEN VON SÖHNEN
            if (type === "Nachricht") {
              createMessage(note, sender, content, timestamp);
              messagesFound++;
            }

            // MANUELLE PRESSEARTIKEL (nur positive)
            if (type === "Presseartikel") {
              const article = {
                title: sender || "Unbekannter Titel",
                content: content,
                subtitle: extra1 || "",
                source: extra2 || "Redaktion",
                date: rawDate || today,
                featured: extra3.toLowerCase() === "ja",
                isAutoGenerated: false
              };
              
              if (isPositiveArticle(article.title, article.content, article.subtitle)) {
                articles.unshift(article); // Manuelle Artikel nach vorne
                articlesFound++;
                console.log(`✅ Positiver Artikel: ${article.title.substring(0, 30)}...`);
              } else {
                console.log(`❌ Artikel gefiltert: ${article.title.substring(0, 30)}...`);
              }
            }
          });
          
          console.log(`✅ Google Sheets verarbeitet: ${remindersFound} Erinnerungen, ${messagesFound} Nachrichten, ${articlesFound} Artikel`);
          break; // Erfolgreich, stoppe weitere Versuche
          
        } catch (error) {
          console.log(`⚠️ Google Sheets API ${api.substring(0, 30)}... fehlgeschlagen:`, error.message);
        }
      }
      
      // FALLBACKS SETZEN
      if (reminders.children.length === 0) {
        reminders.innerHTML = '<li style="font-style: italic; color: #666;">Keine Erinnerungen für heute.</li>';
      }
      
      if (note.children.length === 0) {
        note.innerHTML = '<div style="font-style: italic; color: #666; padding: 1rem;">Keine neuen Nachrichten.</div>';
      }
      
      // ARTIKEL ANZEIGEN
      displayArticles(articles, newsContainer);
      
      console.log("✅ Google Sheets Verarbeitung abgeschlossen");
    }

    function createMessage(container, sender, content, timestamp) {
      if (!sender) return;
      
      const messageWrapper = document.createElement("div");
      messageWrapper.className = "message-with-avatar";
      
      // Avatar
      const avatarDiv = document.createElement("div");
      avatarDiv.className = "message-avatar";
      
      const avatarImg = document.createElement("img");
      avatarImg.src = senderImages[sender] || `https://ui-avatars.com/api/?name=${sender.charAt(0)}&background=667eea&color=fff&size=50`;
      avatarImg.alt = sender;
      avatarImg.onerror = function() {
        this.style.display = 'none';
        avatarDiv.innerHTML = `<div style="color: white; font-weight: bold;">${sender.charAt(0)}</div>`;
      };
      
      avatarDiv.appendChild(avatarImg);
      messageWrapper.appendChild(avatarDiv);
      
      // Content
      const contentDiv = document.createElement("div");
      contentDiv.className = "message-content";
      
      // Datum parsen
      let messageDate = new Date();
      if (timestamp && timestamp.trim()) {
        try {
          messageDate = new Date(timestamp.trim());
          if (isNaN(messageDate.getTime())) {
            messageDate = new Date();
          }
        } catch (e) {
          messageDate = new Date();
        }
      }

      // Neu-Indikator für Nachrichten der letzten 12 Stunden
      const now = new Date();
      const twelveHoursAgo = new Date(now.getTime() - 12 * 60 * 60 * 1000);
      const isNew = messageDate > twelveHoursAgo;
      
      if (isNew) {
        const newIndicator = document.createElement("div");
        newIndicator.className = "new-indicator";
        newIndicator.textContent = `Neu von ${sender}`;
        contentDiv.appendChild(newIndicator);
      } else {
        const senderDiv = document.createElement("div");
        senderDiv.className = "message-sender";
        senderDiv.textContent = sender;
        contentDiv.appendChild(senderDiv);
      }
      
      // Nachricht
      const p = document.createElement("p");
      p.className = "message";
      p.innerHTML = linkifyText(content);
      
      // Zeitstempel
      const ts = document.createElement("div");
      ts.className = "message-timestamp";
      
      let datePrefix = "";
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      
      if (messageDate.toDateString() === new Date().toDateString()) {
        datePrefix = "Heute";
      } else if (messageDate.toDateString() === yesterday.toDateString()) {
        datePrefix = "Gestern";
      } else {
        datePrefix = messageDate.toLocaleDateString('de-DE', {
          day: '2-digit', month: '2-digit', year: '2-digit'
        });
      }

      ts.textContent = `${datePrefix}, ${messageDate.toLocaleTimeString('de-DE', {
        hour: '2-digit', minute: '2-digit', hour12: false
      })}`;
      
      p.appendChild(ts);
      contentDiv.appendChild(p);
      messageWrapper.appendChild(contentDiv);
      
      container.appendChild(messageWrapper);
    }

    function displayArticles(articles, container) {
      if (articles.length === 0) {
        container.innerHTML = `
          <div class="no-articles-message">
            <p>📰 Keine Artikel verfügbar.</p>
          </div>
        `;
        return;
      }
      
      // Nach Featured sortieren, dann nach Datum
      articles.sort((a, b) => {
        if (a.featured && !b.featured) return -1;
        if (!a.featured && b.featured) return 1;
        return new Date(b.date) - new Date(a.date);
      });

      container.innerHTML = "";
      
      articles.forEach(article => {
        const articleElement = document.createElement("article");
        articleElement.className = article.featured ? "news-article featured" : "news-article";
        
        const readingTime = estimateReadingTime(article.content);
        const formattedDate = new Date(article.date).toLocaleDateString('de-DE', {
          day: '2-digit', month: 'long', year: 'numeric'
        });

        const autoTag = article.isAutoGenerated ? ' 🤖' : '';

        articleElement.innerHTML = `
          <div class="news-header">
            <span class="news-source">${article.source}${autoTag}</span>
            <div class="news-meta">
              <span class="news-date">${formattedDate}</span>
              <span class="news-reading-time">${readingTime}</span>
            </div>
          </div>
          <h2 class="news-title">${article.title}</h2>
          ${article.subtitle ? `<h3 class="news-subtitle">${article.subtitle}</h3>` : ''}
          <div class="news-content">
            ${article.content.split('\n\n').map(paragraph => 
              paragraph.trim() ? `<p>${paragraph.trim()}</p>` : ''
            ).join('')}
          </div>
          <div class="news-byline">${article.isAutoGenerated ? 'Automatisch kuratiert' : 'Redaktionsteam'}</div>
        `;
        
        container.appendChild(articleElement);
      });
      
      console.log(`✅ ${articles.length} Artikel angezeigt`);
    }

    // KALENDER LADEN - ROBUSTE VERSION MIT ICAL.JS FALLBACK
    async function loadCalendarData() {
      console.log("📅 Lade Kalender...");
      
      const icalElement = document.getElementById("ical");
      if (!icalElement) return;
      
      // Prüfe ob ICAL.js verfügbar ist
      if (!window.ICAL_AVAILABLE || typeof ICAL === 'undefined') {
        console.log("⚠️ ICAL.js nicht verfügbar - verwende Fallback");
        icalElement.innerHTML = '<div style="font-style: italic; color: #666; padding: 1rem;">Kalenderfunktion wird geladen...</div>';
        
        setTimeout(() => {
          icalElement.innerHTML = '<div style="font-style: italic; color: #666; padding: 1rem;">Keine bevorstehenden Termine.</div>';
        }, 3000);
        return;
      }
      
      const icalUrl = 'https://calendar.google.com/calendar/ical/c07e2a0992894595b6591a5831830abaebefa4287e71915cf353e078fc21cb54@group.calendar.google.com/public/basic.ics';
      
      const proxies = [
        'https://api.allorigins.win/raw?url=',
        'https://corsproxy.io/?',
        ''  // Direkter Aufruf
      ];
      
      for (const proxy of proxies) {
        try {
          console.log(`📅 Versuche Kalender ${proxy || 'direkt'}...`);
          
          const fetchUrl = proxy ? proxy + encodeURIComponent(icalUrl) : icalUrl;
          const response = await fetch(fetchUrl, { timeout: 10000 });
          
          if (!response.ok) continue;
          
          const data = await response.text();
          if (!data.includes('BEGIN:VCALENDAR')) continue;
          
          const comp = new ICAL.Component(ICAL.parse(data));
          const allEvents = comp.getAllSubcomponents('vevent').map(e => new ICAL.Event(e));

          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const in2Days = new Date(today);
          in2Days.setDate(today.getDate() + 2);
          in2Days.setHours(23, 59, 59, 999);

          const events = allEvents
            .filter(e => {
              try {
                const startDate = e.startDate.toJSDate();
                return startDate >= today && startDate <= in2Days;
              } catch (err) {
                return false;
              }
            })
            .sort((a, b) => a.startDate.toJSDate() - b.startDate.toJSDate());

          if (events.length === 0) {
            icalElement.innerHTML = '<div style="font-style: italic; color: #666; padding: 1rem;">Keine bevorstehenden Termine.</div>';
          } else {
            icalElement.innerHTML = "";
            events.forEach(e => {
              try {
                const d = e.startDate.toJSDate();
                const isAllDay = e.startDate.isDate;
                const box = document.createElement("div");
                box.className = "termin-eintrag";
                box.textContent = `📅 ${d.toLocaleDateString('de-DE', {
                  weekday: 'long', day: '2-digit', month: '2-digit'
                })}` + (isAllDay ? ` – ${e.summary}` : `, ${d.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })} – ${e.summary}`);
                icalElement.appendChild(box);
              } catch (err) {
                console.error("Fehler bei Event:", err);
              }
            });
          }
          
          console.log("✅ Kalender geladen");
          return;
          
        } catch (error) {
          console.log(`⚠️ Kalender ${proxy || 'direkt'} fehlgeschlagen:`, error.message);
        }
      }
      
      // Fallback
      icalElement.innerHTML = '<div style="font-style: italic; color: #666; padding: 1rem;">Termine momentan nicht verfügbar.</div>';
      console.log("❌ Alle Kalender-Versuche fehlgeschlagen");
    }

    // BATTERIE PRÜFEN
    function checkBattery() {
      if (typeof fully !== 'undefined') {
        try {
          const batteryLevel = fully.getBatteryLevel();
          const isPluggedIn = fully.isPlugged();
          updateBatteryWarning(batteryLevel, isPluggedIn);
        } catch (error) {
          console.log("Fully Kiosk Browser nicht verfügbar");
        }
      } else if ('getBattery' in navigator) {
        navigator.getBattery().then(function(battery) {
          const level = Math.floor(battery.level * 100);
          updateBatteryWarning(level, battery.charging);
        }).catch(() => {
          console.log("Battery API nicht verfügbar");
        });
      }
    }

    function updateBatteryWarning(level, isCharging) {
      const warningElement = document.getElementById('battery-warning');
      const percentageElement = document.getElementById('battery-percentage');
      
      if (percentageElement) {
        percentageElement.textContent = level;
      }
      
      if (warningElement) {
        if (level <= 30 && !isCharging) {
          warningElement.classList.remove('hidden');
        } else {
          warningElement.classList.add('hidden');
        }
      }
    }

    // INITIALISIERUNG - STABILE VERSION
    function initialize() {
      console.log("🎯 Initialisiere Messageboard...");
      
      // Sofort starten
      initDateTime();
      fetchSheetData();
      loadWeather();
      
      // Kalender mit Verzögerung laden (warten auf ICAL.js)
      setTimeout(() => {
        loadCalendarData();
      }, 2000);
      
      checkBattery();
      
      // Regelmäßige Updates
      setInterval(updateClock, 60000);              // Uhrzeit jede Minute
      setInterval(fetchSheetData, 60000);           // Daten jede Minute
      setInterval(loadWeather, 300000);             // Wetter alle 5 Minuten
      setInterval(loadCalendarData, 600000);        // Kalender alle 10 Minuten
      setInterval(checkBattery, 60000);             // Batterie jede Minute
      
      console.log("✅ Alle Services gestartet!");
    }

    // FEHLERBEHANDLUNG
    window.addEventListener('error', function(e) {
      console.error('JavaScript Fehler:', e.error);
    });

    window.addEventListener('unhandledrejection', function(e) {
      console.error('Promise Fehler:', e.reason);
    });

    // START
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initialize);
    } else {
      initialize();
    }

  </script>

</body>
</html>
