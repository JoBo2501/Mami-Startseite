<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mutters Messageboard - Debug Version</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; 
      padding: 2rem; 
      background: #f8fafc;
      color: #333; 
      text-align: center; 
      margin: 0; 
      min-height: 100vh;
    }
    
    .digital-board {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(to bottom, 
        rgba(255, 183, 77, 0.9) 0%,
        rgba(255, 150, 90, 0.85) 15%,
        rgba(255, 180, 120, 0.8) 30%,
        rgba(135, 180, 220, 0.7) 70%,
        rgba(100, 150, 200, 0.75) 100%
      );
      color: #ffffff;
      text-shadow: 0 2px 8px rgba(0,0,0,0.7);
      border-radius: 25px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      padding: 30px 25px;
      text-align: center;
      margin: 20px auto;
      max-width: 600px;
    }

    .date-display {
      color: #e8e8e8;
      font-size: 1.4rem;
      font-weight: 600;
      margin: 0 0 8px 0;
      letter-spacing: 0.5px;
    }
    
    .time-display {
      color: #ffffff;
      font-size: 3.2rem;
      font-weight: 300;
      margin: 0;
      letter-spacing: 1px;
      font-variant-numeric: tabular-nums;
    }

    .section { 
      margin: 3rem 0;
    }
    
    .section-title { 
      font-weight: 600; 
      font-size: 1.3rem; 
      margin-bottom: 1.5rem; 
      color: #1e293b;
    }
    
    .content-box {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border-radius: 20px; 
      padding: 1.5rem; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      max-width: 600px; 
      margin: 0 auto 1.5rem auto; 
      text-align: left;
      border: 1px solid rgba(255,255,255,0.15);
    }

    .debug-panel {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.9);
      color: #00ff00;
      padding: 15px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 9999;
      border: 2px solid #00ff00;
    }
    
    .debug-title {
      color: #ffff00;
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
    }
    
    .debug-line {
      margin: 3px 0;
      padding: 2px 5px;
      border-radius: 3px;
    }
    
    .debug-success { background: rgba(0, 255, 0, 0.2); }
    .debug-error { background: rgba(255, 0, 0, 0.2); color: #ff6666; }
    .debug-warning { background: rgba(255, 255, 0, 0.2); color: #ffff99; }
    .debug-info { background: rgba(0, 100, 255, 0.2); color: #6699ff; }
    
    .post-it-sticker {
      position: fixed;
      top: 20%;
      left: -25px;
      width: 220px;
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
      border-radius: 12px;
      box-shadow: 0 15px 30px rgba(0,0,0,0.2);
      transform: rotate(-4deg);
      z-index: 1000;
      padding: 1.5rem;
      text-align: center;
    }

    .post-it-title {
      font-size: 1rem;
      font-weight: 700;
      color: #d63031;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .post-it-text {
      font-size: 0.9rem;
      color: #2d3436;
      line-height: 1.4;
      font-weight: 600;
    }
    
    .test-button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    
    .test-button:hover {
      background: #45a049;
    }

    @media (max-width: 768px) {
      .debug-panel {
        position: relative;
        max-width: 100%;
        margin: 20px auto;
        top: auto;
        right: auto;
      }
      
      .post-it-sticker {
        position: relative;
        left: 0;
        transform: none;
        margin: 20px auto;
        display: block;
      }
    }
  </style>
</head>
<body>

<!-- Debug Panel - Immer sichtbar -->
<div id="debug-panel" class="debug-panel">
  <div class="debug-title">üîß SYSTEM DEBUG</div>
  <div id="debug-content">Initialisierung...</div>
  <div style="margin-top: 10px; text-align: center;">
    <button class="test-button" onclick="testDateTime()">Test Uhrzeit</button>
    <button class="test-button" onclick="testWeather()">Test Wetter</button>
    <button class="test-button" onclick="testSheets()">Test Sheets</button>
    <button class="test-button" onclick="clearDebug()">Clear</button>
  </div>
</div>

<!-- Post-it Sticker -->
<div class="post-it-sticker">
  <div class="post-it-title">WICHTIGER HINWEIS</div>
  <div class="post-it-text">
    Sanja bitte bis auf weiteres nicht mehr bar bezahlen, das erfolgt jetzt online!
  </div>
</div>

<div class="digital-board">
  <div id="date" class="date-display">L√§dt...</div>
  <div id="time" class="time-display">--:--</div>
</div>

<div class="section">
  <div class="section-title">üîî Erinnerungen f√ºr heute</div>
  <div class="content-box" id="reminders">Lade Erinnerungen...</div>
</div>

<div class="section">
  <div class="section-title">üí¨ Nachrichten von den S√∂hnen</div>
  <div class="content-box" id="note">Lade Nachrichten...</div>
</div>

<div class="section">
  <div class="section-title">üìÖ Bevorstehende Termine</div>
  <div class="content-box" id="ical">Lade Termine...</div>
</div>

<div class="section">
  <div class="section-title">üå§Ô∏è Wetter heute in Pullach</div>
  <div class="content-box" id="weather">Lade Wetterdaten...</div>
</div>

<div class="section">
  <div class="section-title">üì∞ Presseschau</div>
  <div class="content-box" id="news-container">Lade Presseschau...</div>
</div>

<script>
// GLOBALE DEBUG SYSTEM
let debugMessages = [];
let debugCounter = 0;

function debugLog(message, type = 'info') {
  debugCounter++;
  const timestamp = new Date().toLocaleTimeString('de-DE');
  const formattedMessage = `${debugCounter}. [${timestamp}] ${message}`;
  
  debugMessages.push({ message: formattedMessage, type });
  console.log(`üîß ${formattedMessage}`);
  
  updateDebugDisplay();
  
  // Scrolle zum neuesten Eintrag
  const debugPanel = document.getElementById('debug-panel');
  if (debugPanel) {
    debugPanel.scrollTop = debugPanel.scrollHeight;
  }
}

function updateDebugDisplay() {
  const debugContent = document.getElementById('debug-content');
  if (debugContent) {
    debugContent.innerHTML = debugMessages.slice(-20).map(item => 
      `<div class="debug-line debug-${item.type}">${item.message}</div>`
    ).join('');
  }
}

function clearDebug() {
  debugMessages = [];
  debugCounter = 0;
  updateDebugDisplay();
  debugLog("Debug Panel geleert", "info");
}

// SOFORTIGE TESTS
debugLog("üöÄ Messageboard startet...", "info");
debugLog("Browser: " + navigator.userAgent.substring(0, 50) + "...", "info");
debugLog("Datum/Zeit: " + new Date().toLocaleString('de-DE'), "info");

// TEST: DOM-Elemente finden
setTimeout(() => {
  const elements = ['date', 'time', 'reminders', 'note', 'ical', 'weather', 'news-container'];
  elements.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      debugLog(`‚úÖ Element gefunden: ${id}`, "success");
    } else {
      debugLog(`‚ùå Element NICHT gefunden: ${id}`, "error");
    }
  });
}, 100);

// DATUM UND UHRZEIT - Einfachste Version
function initDateTime() {
  debugLog("‚è∞ Starte Datum/Uhrzeit...", "info");
  
  try {
    const now = new Date();
    debugLog("Aktuelles Datum object: " + now.toString(), "info");
    
    const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
    const months = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
    
    const weekday = weekdays[now.getDay()];
    const day = now.getDate();
    const month = months[now.getMonth()];
    const year = now.getFullYear();
    
    const dateString = `${weekday}, ${day}. ${month} ${year}`;
    debugLog("Formatiertes Datum: " + dateString, "info");
    
    const dateElement = document.getElementById("date");
    if (dateElement) {
      dateElement.innerHTML = `<strong>${dateString}</strong>`;
      debugLog("‚úÖ Datum gesetzt", "success");
    } else {
      debugLog("‚ùå Datum-Element nicht gefunden!", "error");
    }
    
    updateClock();
    
  } catch (error) {
    debugLog("‚ùå Fehler bei Datum/Uhrzeit: " + error.message, "error");
    debugLog("Error stack: " + error.stack, "error");
  }
}

function updateClock() {
  try {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const timeString = `${hours}:${minutes}`;
    
    const timeElement = document.getElementById("time");
    if (timeElement) {
      timeElement.innerHTML = timeString;
      // Debug nur bei Minuten-Wechsel
      if (minutes === '00' || debugCounter < 5) {
        debugLog("‚è∞ Uhrzeit: " + timeString, "success");
      }
    } else {
      debugLog("‚ùå Zeit-Element nicht gefunden!", "error");
    }
  } catch (error) {
    debugLog("‚ùå Uhrzeitfehler: " + error.message, "error");
  }
}

// WETTER LADEN - Vereinfachte Version
async function loadWeather() {
  debugLog("üå§Ô∏è Lade Wetter...", "info");
  
  const weatherElement = document.getElementById("weather");
  if (!weatherElement) {
    debugLog("‚ùå Wetter-Element nicht gefunden!", "error");
    return;
  }
  
  try {
    // Direkte API ohne Proxy versuchen
    debugLog("Versuche direkte Open-Meteo API...", "info");
    const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=48.066&longitude=11.520&current_weather=true');
    
    debugLog("Wetter API Status: " + response.status, "info");
    
    if (response.ok) {
      const data = await response.json();
      debugLog("Wetter Daten erhalten: " + JSON.stringify(data).substring(0, 100) + "...", "success");
      
      const temp = Math.round(data.current_weather.temperature);
      const windspeed = Math.round(data.current_weather.windspeed);
      const weathercode = data.current_weather.weathercode;
      
      let weatherIcon = "üå°Ô∏è";
      let description = "Unbekannt";
      
      if (weathercode <= 2) {
        weatherIcon = "‚òÄÔ∏è";
        description = "Sonnig";
      } else if (weathercode === 3) {
        weatherIcon = "‚òÅÔ∏è";
        description = "Bew√∂lkt";
      } else if (weathercode >= 51 && weathercode <= 67) {
        weatherIcon = "üåßÔ∏è";
        description = "Regen";
      } else if (weathercode >= 95) {
        weatherIcon = "‚õàÔ∏è";
        description = "Gewitter";
      }
      
      weatherElement.innerHTML = `
        <div style="font-size: 1.2rem; margin-bottom: 10px;">
          <strong>${weatherIcon} ${description}</strong>
        </div>
        <div style="font-size: 1.1rem; margin: 5px 0;">
          üå°Ô∏è <strong>${temp}¬∞C</strong>
        </div>
        <div style="font-size: 1.1rem; margin: 5px 0;">
          üí® <strong>${windspeed} km/h</strong>
        </div>
      `;
      
      debugLog("‚úÖ Wetter angezeigt: " + temp + "¬∞C, " + description, "success");
      
    } else {
      throw new Error("HTTP " + response.status);
    }
    
  } catch (error) {
    debugLog("‚ùå Wetter-API Fehler: " + error.message, "error");
    weatherElement.innerHTML = `
      <div style="font-size: 1.1rem; color: #666;">
        üå°Ô∏è Wetter momentan nicht verf√ºgbar<br>
        <small>Fehler: ${error.message}</small>
      </div>
    `;
  }
}

// GOOGLE SHEETS LADEN - Vereinfachte Version
async function loadSheets() {
  debugLog("üìä Lade Google Sheets...", "info");
  
  const remindersElement = document.getElementById("reminders");
  const noteElement = document.getElementById("note");
  const newsElement = document.getElementById("news-container");
  
  if (!remindersElement || !noteElement || !newsElement) {
    debugLog("‚ùå Ein oder mehrere Content-Elemente nicht gefunden!", "error");
    return;
  }
  
  try {
    const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRB56yMX7C4q-o3tDU4dVZGxive_c-x84aii2HXnI1RULRdYKqloZ9JtKcFHe0TXsmPbJOEOqZDtZUb/pub?output=tsv';
    debugLog("Google Sheets URL: " + url.substring(0, 80) + "...", "info");
    
    // Erst direkt versuchen
    debugLog("Versuche direkten Sheets-Aufruf...", "info");
    let response = await fetch(url + '&t=' + Date.now());
    
    debugLog("Sheets API Status: " + response.status, "info");
    debugLog("Sheets Content-Type: " + response.headers.get('content-type'), "info");
    
    if (!response.ok) {
      // Mit Proxy versuchen
      debugLog("Direkter Aufruf fehlgeschlagen, versuche Proxy...", "warning");
      response = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(url));
      debugLog("Proxy Status: " + response.status, "info");
    }
    
    if (response.ok) {
      const text = await response.text();
      debugLog("Sheets Textl√§nge: " + text.length + " Zeichen", "info");
      debugLog("Erste 200 Zeichen: " + text.substring(0, 200), "info");
      
      if (text.includes('<!DOCTYPE') || text.includes('<html')) {
        debugLog("‚ùå HTML statt TSV erhalten - Sheets m√∂glicherweise nicht √∂ffentlich", "error");
        showFallbackContent();
        return;
      }
      
      if (text.trim().length === 0) {
        debugLog("‚ùå Leere Antwort von Sheets", "error");
        showFallbackContent();
        return;
      }
      
      const rows = text.trim().split('\n');
      debugLog("Gefundene Zeilen: " + rows.length, "info");
      
      let remindersCount = 0;
      let messagesCount = 0;
      let articlesCount = 0;
      
      rows.forEach((row, index) => {
        const cols = row.split('\t');
        if (cols.length < 2) return;
        
        const type = cols[0]?.trim();
        const content = cols[1]?.trim();
        
        if (!type || !content) return;
        
        debugLog(`Zeile ${index + 1}: ${type} - ${content.substring(0, 30)}...`, "info");
        
        if (type === "Erinnerung") {
          remindersCount++;
        } else if (type === "Nachricht") {
          messagesCount++;
        } else if (type === "Presseartikel") {
          articlesCount++;
        }
      });
      
      debugLog(`‚úÖ Sheets verarbeitet: ${remindersCount} Erinnerungen, ${messagesCount} Nachrichten, ${articlesCount} Artikel`, "success");
      
      // Einfache Fallback-Anzeige
      remindersElement.innerHTML = remindersCount > 0 ? `${remindersCount} Erinnerungen gefunden` : "Keine Erinnerungen f√ºr heute";
      noteElement.innerHTML = messagesCount > 0 ? `${messagesCount} Nachrichten gefunden` : "Keine neuen Nachrichten";
      newsElement.innerHTML = articlesCount > 0 ? `${articlesCount} Artikel gefunden` : "Keine Artikel verf√ºgbar";
      
    } else {
      throw new Error("HTTP " + response.status);
    }
    
  } catch (error) {
    debugLog("‚ùå Sheets-Fehler: " + error.message, "error");
    showFallbackContent();
  }
}

function showFallbackContent() {
  debugLog("Zeige Fallback-Inhalte", "warning");
  
  document.getElementById("reminders").innerHTML = "üìù Demo-Erinnerung: Arzttermin um 14:00";
  document.getElementById("note").innerHTML = "üí¨ Demo-Nachricht: Hallo Mama, alles in Ordnung!";
  document.getElementById("news-container").innerHTML = "üì∞ Demo-Artikel: Lokale Nachrichten werden geladen...";
}

// KALENDER LADEN - Vereinfachte Version
async function loadCalendar() {
  debugLog("üìÖ Lade Kalender...", "info");
  
  const icalElement = document.getElementById("ical");
  if (!icalElement) {
    debugLog("‚ùå Kalender-Element nicht gefunden!", "error");
    return;
  }
  
  // F√ºr jetzt nur Fallback
  icalElement.innerHTML = "üìÖ Kalenderfunktion wird getestet...";
  debugLog("‚ö†Ô∏è Kalender-Funktion tempor√§r deaktiviert", "warning");
}

// TEST-FUNKTIONEN
function testDateTime() {
  debugLog("üß™ Teste Datum/Uhrzeit manuell...", "info");
  initDateTime();
}

function testWeather() {
  debugLog("üß™ Teste Wetter manuell...", "info");
  loadWeather();
}

function testSheets() {
  debugLog("üß™ Teste Google Sheets manuell...", "info");
  loadSheets();
}

// INITIALISIERUNG
debugLog("Warte auf DOM...", "info");

document.addEventListener('DOMContentLoaded', function() {
  debugLog("‚úÖ DOM geladen!", "success");
  
  // Sofort starten mit Delays
  setTimeout(() => {
    debugLog("Starte Datum/Uhrzeit...", "info");
    initDateTime();
  }, 100);
  
  setTimeout(() => {
    debugLog("Starte Wetter...", "info");
    loadWeather();
  }, 500);
  
  setTimeout(() => {
    debugLog("Starte Google Sheets...", "info");
    loadSheets();
  }, 1000);
  
  setTimeout(() => {
    debugLog("Starte Kalender...", "info");
    loadCalendar();
  }, 1500);
  
  // Regelm√§√üige Updates
  setInterval(updateClock, 60000);
  setInterval(loadWeather, 300000);
  setInterval(loadSheets, 60000);
  
  debugLog("‚úÖ Alle Timer gestartet!", "success");
});

// FEHLER-HANDLER
window.onerror = function(msg, url, line, col, error) {
  debugLog("üí• JAVASCRIPT FEHLER: " + msg, "error");
  debugLog("Datei: " + url + " Zeile: " + line, "error");
  if (error && error.stack) {
    debugLog("Stack: " + error.stack.substring(0, 200), "error");
  }
  return false;
};

debugLog("‚úÖ Debug-System initialisiert", "success");
</script>

</body>
</html>
